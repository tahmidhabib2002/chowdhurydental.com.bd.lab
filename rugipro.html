<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>রোগী প্রোফাইল - চৌধুরী ডেন্টাল</title>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --success: #28a745;
            --success-dark: #1e7e34;
            --danger: #dc3545;
            --warning: #ff9800;
            --purple: #6f42c1;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f2ff 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .patient-info {
            flex: 1;
        }

        .patient-name {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .patient-details {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-item i {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Patient Selection Modal */
        .patient-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .patient-modal.active {
            display: flex;
        }

        .patient-modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .patient-modal-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .patient-list {
            margin-top: 20px;
        }

        .patient-item {
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .patient-item:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }

        .patient-item.active {
            border-color: var(--success);
            background: #e8f5e9;
        }

        .patient-search {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            border-top: 5px solid var(--primary);
        }

        .stat-card.success {
            border-color: var(--success);
        }

        .stat-card.danger {
            border-color: var(--danger);
        }

        .stat-card.warning {
            border-color: var(--warning);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 1.1rem;
        }

        /* Payment Section */
        .payment-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            display: none;
        }

        .payment-section.active {
            display: block;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1.1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Edit Patient Modal */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3001;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* SMS Section */
        .sms-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .sms-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .sms-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 10px;
        }

        .sms-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .char-count {
            text-align: right;
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .char-count.warning {
            color: var(--warning);
            font-weight: bold;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 20px;
            border: 2px solid var(--light-gray);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn:hover {
            border-color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* History Cards */
        .history-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .history-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }

        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .history-card.paid {
            border-color: var(--success);
        }

        .history-card.due {
            border-color: var(--danger);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .history-date {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .history-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .history-details {
            margin-top: 15px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--dark);
            min-width: 150px;
        }

        .detail-value {
            color: var(--gray);
            flex: 1;
        }

        /* Payment Log */
        .payment-log {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--light-gray);
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .log-item:last-child {
            border-bottom: none;
        }

        /* Buttons */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68900 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray) 0%, #5a6268 100%);
            color: white;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Back Button */
        .back-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 100;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
        }

        .message-error {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
        }

        .message-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68900 100%);
        }

        .message-info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .patient-details {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .detail-row {
                flex-direction: column;
            }
            
            .detail-label {
                min-width: auto;
                margin-bottom: 5px;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .back-btn {
                bottom: 20px;
                left: 20px;
                right: 20px;
            }
            
            .back-btn .btn {
                width: 100%;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }

        .empty-icon {
            font-size: 3rem;
            color: var(--light-gray);
            margin-bottom: 20px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }
            
            .container {
                max-width: 100% !important;
                margin: 0 !important;
            }
            
            .header, .stats-grid, .action-buttons, .sms-section, .back-btn,
            #addPaymentBtn, #addTreatmentBtn, #editPatientBtn, #backToDashboardBtn {
                display: none !important;
            }
            
            .history-section {
                box-shadow: none !important;
                padding: 20px 0 !important;
                margin: 0 !important;
            }
            
            .history-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Patient Selection Modal -->
    <div class="patient-modal" id="patientSelectionModal">
        <div class="patient-modal-content">
            <h3 class="patient-modal-title">
                <i class="fas fa-users"></i>
                রোগী নির্বাচন করুন
            </h3>
            <input type="text" id="patientSearch" class="patient-search" placeholder="রোগী নাম দিয়ে সার্চ করুন...">
            <p id="modalMessage">এই মোবাইল নাম্বারে একাধিক রোগী পাওয়া গেছে। নিচ থেকে নির্বাচন করুন:</p>
            <div class="patient-list" id="patientList">
                <!-- Patients will be listed here -->
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-danger" id="cancelPatientSelection">
                    বাতিল
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Patient Modal -->
    <div class="edit-modal" id="editPatientModal">
        <div class="edit-modal-content">
            <h3 class="patient-modal-title">
                <i class="fas fa-edit"></i>
                রোগী তথ্য এডিট করুন
            </h3>
            <form id="editPatientForm">
                <div class="form-group">
                    <label for="editName" class="form-label">রোগীর নাম *</label>
                    <input type="text" id="editName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editAge" class="form-label">বয়স</label>
                    <input type="number" id="editAge" class="form-control" min="0" max="120">
                </div>
                <div class="form-group">
                    <label for="editPhone" class="form-label">মোবাইল নাম্বার *</label>
                    <input type="tel" id="editPhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editAddress" class="form-label">ঠিকানা/গ্রাম</label>
                    <input type="text" id="editAddress" class="form-control">
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        সংরক্ষণ করুন
                    </button>
                    <button type="button" class="btn btn-danger" id="cancelEditBtn">
                        বাতিল
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header" id="patientHeader">
            <div class="header-content">
                <div class="patient-info">
                    <h1 class="patient-name" id="patientName">রোগীর নাম লোড হচ্ছে...</h1>
                    <div class="patient-details">
                        <div class="detail-item">
                            <i class="fas fa-phone"></i>
                            <span id="patientPhone">মোবাইল: লোড হচ্ছে...</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-home"></i>
                            <span id="patientAddress">ঠিকানা: লোড হচ্ছে...</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span id="patientAge">বয়স: লোড হচ্ছে...</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-id-card"></i>
                            <span id="patientCount">লোড হচ্ছে...</span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-warning" id="switchPatientBtn" style="display: none;">
                        <i class="fas fa-exchange-alt"></i>
                        রোগী পরিবর্তন
                    </button>
                    <button class="btn btn-primary" id="printBtn">
                        <i class="fas fa-print"></i>
                        প্রিন্ট
                    </button>
                    <button class="btn btn-danger" id="backBtn">
                        <i class="fas fa-arrow-left"></i>
                        ব্যাক
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalBill">৳ 0</div>
                <div class="stat-label">সর্বমোট বিল</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="totalPaid">৳ 0</div>
                <div class="stat-label">মোট জমা</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-value" id="totalDue">৳ 0</div>
                <div class="stat-label">মোট বকেয়া</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="totalTreatments">0</div>
                <div class="stat-label">মোট চিকিৎসা</div>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="payment-section" id="paymentSection">
            <h2 style="margin-bottom: 25px; color: var(--primary); text-align: center;">
                <i class="fas fa-money-bill-wave"></i>
                বকেয়া জমা নিন
            </h2>
            <div class="payment-form">
                <div class="form-group">
                    <label for="paymentAmount" class="form-label">টাকার পরিমাণ (৳)</label>
                    <input type="number" id="paymentAmount" class="form-control" placeholder="টাকার পরিমাণ লিখুন" min="1" required>
                </div>
                <div class="form-group">
                    <label for="paymentDate" class="form-label">তারিখ</label>
                    <input type="datetime-local" id="paymentDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="paymentNotes" class="form-label">নোট (যদি থাকে)</label>
                    <textarea id="paymentNotes" class="form-control" placeholder="যেকোনো নোট..." rows="3"></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" id="submitPaymentBtn" style="flex: 1;">
                        <i class="fas fa-check"></i>
                        টাকা জমা দিন
                    </button>
                    <button class="btn btn-danger" id="cancelPaymentBtn" style="flex: 1;">
                        বাতিল করুন
                    </button>
                </div>
            </div>
        </div>

        <!-- SMS Section -->
        <div class="sms-section">
            <h2 style="margin-bottom: 25px; color: var(--primary);">
                <i class="fas fa-sms"></i>
                এসএমএস পাঠান
            </h2>
            
            <div class="sms-warning">
                <i class="fas fa-exclamation-triangle"></i>
                বাংলা এসএমএস সর্বোচ্চ ৭০ অক্ষরের মধ্যে সীমাবদ্ধ
            </div>
            
            <!-- Due SMS -->
            <div class="sms-box">
                <h3 style="margin-bottom: 15px; color: var(--danger);">
                    <i class="fas fa-exclamation-circle"></i>
                    বকেয়া বিলের মেসেজ
                </h3>
                <textarea class="sms-textarea" id="dueSmsText" placeholder="বকেয়া বিলের মেসেজ স্বয়ংক্রিয়ভাবে তৈরি হবে..."></textarea>
                <div class="char-count" id="dueCharCount">0/70</div>
                <button class="btn btn-primary" id="sendDueSmsBtn">
                    <i class="fas fa-paper-plane"></i>
                    বকেয়া এসএমএস পাঠান
                </button>
            </div>

            <!-- Crown SMS -->
            <div class="sms-box" id="crownSmsBox" style="display: none;">
                <h3 style="margin-bottom: 15px; color: var(--warning);">
                    <i class="fas fa-crown"></i>
                    ক্রাউন/ক্যাপ মেসেজ
                </h3>
                <textarea class="sms-textarea" id="crownSmsText" placeholder="ক্রাউন/ক্যাপ মেসেজ..."></textarea>
                <div class="char-count" id="crownCharCount">0/70</div>
                <button class="btn btn-warning" id="sendCrownSmsBtn">
                    <i class="fas fa-paper-plane"></i>
                    ক্রাউন এসএমএস পাঠান
                </button>
            </div>

            <!-- Custom SMS -->
            <div class="sms-box">
                <h3 style="margin-bottom: 15px; color: var(--success);">
                    <i class="fas fa-edit"></i>
                    কাস্টম মেসেজ
                </h3>
                <textarea class="sms-textarea" id="customSmsText" placeholder="আপনার কাস্টম মেসেজ লিখুন..."></textarea>
                <div class="char-count" id="customCharCount">0/70</div>
                <button class="btn btn-success" id="sendCustomSmsBtn">
                    <i class="fas fa-paper-plane"></i>
                    কাস্টম এসএমএস পাঠান
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h3 style="margin-bottom: 15px; color: var(--primary);">
                <i class="fas fa-filter"></i>
                ফিল্টার
            </h3>
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all">সব</button>
                <button class="filter-btn" data-filter="due">বকেয়া আছে</button>
                <button class="filter-btn" data-filter="paid">পরিশোধিত</button>
                <button class="filter-btn" data-filter="crown">ক্রাউন আছে</button>
                <button class="filter-btn" data-filter="recent">সাম্প্রতিক ৭ দিন</button>
            </div>
        </div>

        <!-- Treatment History -->
        <div class="history-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="color: var(--primary);">
                    <i class="fas fa-history"></i>
                    চিকিৎসা ও পেমেন্ট ইতিহাস
                </h2>
                <div style="color: var(--gray);">
                    <i class="fas fa-sort-amount-down"></i>
                    সর্বশেষ চিকিৎসা উপরে
                </div>
            </div>
            
            <div id="treatmentHistory">
                <!-- Treatment history will be loaded here -->
                <div class="empty-state">
                    <i class="fas fa-history empty-icon"></i>
                    <p>কোনো চিকিৎসা ইতিহাস নেই</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">রোগীর চিকিৎসা তথ্য লোড হচ্ছে...</p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="addPaymentBtn">
                <i class="fas fa-plus-circle"></i>
                নতুন পেমেন্ট যোগ করুন
            </button>
            <button class="btn btn-warning" id="addTreatmentBtn">
                <i class="fas fa-stethoscope"></i>
                নতুন চিকিৎসা যোগ করুন
            </button>
            <button class="btn btn-success" id="editPatientBtn">
                <i class="fas fa-edit"></i>
                রোগী তথ্য এডিট করুন
            </button>
            <button class="btn btn-secondary" id="exportBtn">
                <i class="fas fa-download"></i>
                রিপোর্ট ডাউনলোড
            </button>
        </div>
    </div>

    <!-- Back Button -->
    <div class="back-btn">
        <button class="btn btn-danger" id="backToDashboardBtn">
            <i class="fas fa-arrow-left"></i>
            ড্যাশবোর্ডে ফিরুন
        </button>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            arrayUnion,
            collection,
            query,
            where,
            getDocs,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAxz46ug-CAywevI-PzmOp7ba5iiCK9dfM",
            authDomain: "plasma-raceway-465016-v0.firebaseapp.com",
            projectId: "plasma-raceway-465016-v0",
            storageBucket: "plasma-raceway-465016-v0.appspot.com",
            messagingSenderId: "23620370976",
            appId: "1:23620370976:web:3bb119ceb9e15608a33245"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get patient ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const profileId = urlParams.get('profileId');
        const phone = urlParams.get('phone');

        // Global variables
        let currentPatient = null;
        let currentPhone = null;
        let allPatientsWithSamePhone = [];
        let currentPatientIndex = 0;
        let allTreatments = [];
        let currentFilter = 'all';

        // Authentication Check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "log.html";
            } else {
                initializePage();
            }
        });

        // Initialize page
        async function initializePage() {
            try {
                if (profileId) {
                    // Load specific patient
                    await loadSpecificPatient(profileId);
                } else if (phone) {
                    // Load all patients with this phone number
                    currentPhone = phone;
                    await loadPatientsByPhone(phone);
                } else {
                    // Try to load recent patients (limit to 5 for performance)
                    await loadRecentPatients(5);
                }
            } catch (error) {
                console.error("Error initializing page:", error);
                showMessage("পেইজ লোড করতে সমস্যা হয়েছে!", "error");
            }
        }

        // Load specific patient by profileId
        async function loadSpecificPatient(profileId) {
            try {
                const patientDoc = doc(db, "patients", profileId);
                const patientSnap = await getDoc(patientDoc);
                
                if (patientSnap.exists()) {
                    const patientData = patientSnap.data();
                    currentPatient = {
                        id: profileId,
                        data: patientData
                    };
                    
                    // Get all patients with same phone number
                    currentPhone = patientData.phone;
                    await loadPatientsByPhone(currentPhone, profileId);
                } else {
                    showMessage("রোগীর তথ্য পাওয়া যায়নি!", "error");
                    setTimeout(() => {
                        window.location.href = "amarghor.html";
                    }, 2000);
                }
            } catch (error) {
                console.error("Error loading patient:", error);
                showMessage("রোগী লোড করতে সমস্যা হয়েছে!", "error");
            }
        }

        // Load all patients with same phone number
        async function loadPatientsByPhone(phone, selectedProfileId = null) {
            try {
                // Query all patients with this phone number
                const patientsRef = collection(db, "patients");
                const q = query(patientsRef, where("phone", "==", phone));
                const querySnapshot = await getDocs(q);
                
                allPatientsWithSamePhone = [];
                
                querySnapshot.forEach(doc => {
                    const patientData = doc.data();
                    allPatientsWithSamePhone.push({
                        id: doc.id,
                        data: patientData,
                        lastTreatmentDate: getLastTreatmentDate(patientData)
                    });
                });
                
                // Sort by last treatment date (newest first)
                allPatientsWithSamePhone.sort((a, b) => {
                    return new Date(b.lastTreatmentDate) - new Date(a.lastTreatmentDate);
                });
                
                if (allPatientsWithSamePhone.length === 0) {
                    showMessage("কোনো রোগী পাওয়া যায়নি!", "error");
                    return;
                }
                
                // If a specific profile was selected, find its index
                if (selectedProfileId) {
                    const index = allPatientsWithSamePhone.findIndex(p => p.id === selectedProfileId);
                    currentPatientIndex = index !== -1 ? index : 0;
                } else {
                    currentPatientIndex = 0; // Show most recent patient by default
                }
                
                // Load the selected patient
                await loadCurrentPatient();
                
                // If multiple patients, show switch button
                if (allPatientsWithSamePhone.length > 1) {
                    document.getElementById('switchPatientBtn').style.display = 'flex';
                    document.getElementById('patientCount').textContent = 
                        `${currentPatientIndex + 1}/${allPatientsWithSamePhone.length} জন`;
                } else {
                    document.getElementById('switchPatientBtn').style.display = 'none';
                    document.getElementById('patientCount').textContent = '১ জন রোগী';
                }
                
            } catch (error) {
                console.error("Error loading patients by phone:", error);
                showMessage("রোগী লোড করতে সমস্যা হয়েছে!", "error");
            }
        }

        // Load recent patients (for dashboard access)
        async function loadRecentPatients(limitCount = 5) {
            try {
                // Get the last patients from query
                const patientsRef = collection(db, "patients");
                const q = query(patientsRef, orderBy("lastUpdated", "desc"), limit(limitCount));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showMessage("কোনো সাম্প্রতিক রোগী নেই!", "info");
                    return;
                }
                
                // Show selection modal
                const modalMessage = document.getElementById('modalMessage');
                const patientList = document.getElementById('patientList');
                
                modalMessage.textContent = "সাম্প্রতিক রোগীরা। নিচ থেকে নির্বাচন করুন:";
                patientList.innerHTML = '';
                
                querySnapshot.forEach((doc, index) => {
                    const patientData = doc.data();
                    const lastTreatmentDate = getLastTreatmentDate(patientData);
                    
                    const patientItem = document.createElement('div');
                    patientItem.className = 'patient-item';
                    patientItem.innerHTML = `
                        <h4 style="margin-bottom: 5px; color: var(--primary);">${patientData.name}</h4>
                        <p style="color: var(--gray); margin-bottom: 5px;">
                            <i class="fas fa-phone"></i> ${patientData.phone}
                            ${patientData.age ? ` | <i class="fas fa-user"></i> ${patientData.age} বছর` : ''}
                        </p>
                        <p style="color: var(--dark); font-size: 0.9rem;">
                            সর্বশেষ চিকিৎসা: ${formatDate(lastTreatmentDate)}
                        </p>
                    `;
                    
                    patientItem.addEventListener('click', () => {
                        window.location.href = `rugipro.html?profileId=${doc.id}`;
                    });
                    
                    patientList.appendChild(patientItem);
                });
                
                document.getElementById('patientSelectionModal').classList.add('active');
                
            } catch (error) {
                console.error("Error loading recent patients:", error);
                showMessage("সাম্প্রতিক রোগী লোড করতে সমস্যা!", "error");
            }
        }

        // Load current patient data
        async function loadCurrentPatient() {
            if (allPatientsWithSamePhone.length === 0 || currentPatientIndex >= allPatientsWithSamePhone.length) {
                return;
            }
            
            currentPatient = allPatientsWithSamePhone[currentPatientIndex];
            displayPatientData(currentPatient.data);
        }

        // Display Patient Data
        function displayPatientData(patientData) {
            console.log("Displaying Patient Data:", patientData);
            
            // Basic Info
            document.getElementById('patientName').textContent = patientData.name || 'নাম নেই';
            document.getElementById('patientPhone').textContent = `মোবাইল: ${patientData.phone || 'নাম্বার নেই'}`;
            document.getElementById('patientAddress').textContent = `ঠিকানা: ${patientData.address || 'ঠিকানা নেই'}`;
            document.getElementById('patientAge').textContent = `বয়স: ${patientData.age || 'নেই'}`;
            
            if (allPatientsWithSamePhone.length > 1) {
                document.getElementById('patientCount').textContent = 
                    `${currentPatientIndex + 1}/${allPatientsWithSamePhone.length} জন`;
            } else {
                document.getElementById('patientCount').textContent = '১ জন রোগী';
            }

            // Calculate Statistics
            let totalBill = 0;
            let totalPaid = 0;
            let totalDue = 0;
            let totalTreatments = 0;
            let hasCrown = false;
            
            allTreatments = [];

            if (patientData.treatments && patientData.treatments.length > 0) {
                totalTreatments = patientData.treatments.length;
                
                // Sort treatments by date (newest first)
                const sortedTreatments = [...patientData.treatments].sort((a, b) => {
                    return new Date(b.date || b.id) - new Date(a.date || a.id);
                });

                sortedTreatments.forEach((treatment, index) => {
                    const treatmentTotal = parseFloat(treatment.total || treatment.treatmentCost || 0);
                    const treatmentPaid = parseFloat(treatment.paid || 0);
                    const treatmentDue = parseFloat(treatment.due || treatmentTotal - treatmentPaid);
                    
                    totalBill += treatmentTotal;
                    totalPaid += treatmentPaid;
                    totalDue += treatmentDue;

                    if (treatment.hasCrown) {
                        hasCrown = true;
                    }

                    // Store treatment for filtering
                    allTreatments.push({
                        ...treatment,
                        index: index,
                        isPaid: treatmentDue <= 0,
                        hasCrown: treatment.hasCrown || false,
                        treatmentDate: treatment.date || treatment.id,
                        formattedDate: formatDate(treatment.date || treatment.id)
                    });
                });
            }

            // Update Statistics
            document.getElementById('totalBill').textContent = `৳ ${totalBill.toLocaleString('bn-BD')}`;
            document.getElementById('totalPaid').textContent = `৳ ${totalPaid.toLocaleString('bn-BD')}`;
            document.getElementById('totalDue').textContent = `৳ ${totalDue.toLocaleString('bn-BD')}`;
            document.getElementById('totalTreatments').textContent = totalTreatments;

            // Update Treatment History with filter
            updateTreatmentHistory();

            // Show/Hide Payment Section
            if (totalDue > 0) {
                document.getElementById('paymentSection').classList.add('active');
            } else {
                document.getElementById('paymentSection').classList.remove('active');
            }

            // Show/Hide Crown SMS Box
            if (hasCrown) {
                document.getElementById('crownSmsBox').style.display = 'block';
                document.getElementById('crownSmsText').value = `সম্মানিত গ্রাহক,আপনার দাঁতের ক্যাপ তৈরি হয়েছে। শুক্রবার ব্যতীত চেম্বার চলাকালীন সময়ে এসে ক্যাপ লাগিয়ে নেওয়ার জন্য অনুরোধ করা গেলো। ধন্যবাদ,চৌধুরী ডেন্টাল লালমোহন। 01715586670`;
                updateCharCount('crownSmsText', 'crownCharCount');
            } else {
                document.getElementById('crownSmsBox').style.display = 'none';
            }

            // Auto-generate due SMS
            const latestTreatment = patientData.treatments && patientData.treatments.length > 0 
                ? patientData.treatments[patientData.treatments.length - 1] 
                : null;
            
            let dueSms = '';
            if (latestTreatment && totalDue > 0) {
                dueSms = `সম্মানিত গ্রাহক, ${patientData.name} এর ${latestTreatment.problem || 'চিকিৎসা'} বিল:${latestTreatment.total}/-,জমা:${latestTreatment.paid}/-,বকেয়া:${latestTreatment.due}/-। চৌধুরী ডেন্টাল`;
            } else if (totalDue > 0) {
                dueSms = `সম্মানিত গ্রাহক, ${patientData.name} এর বকেয়া:${totalDue}/-। চৌধুরী ডেন্টাল`;
            } else {
                dueSms = `সম্মানিত গ্রাহক, ${patientData.name}, চৌধুরী ডেন্টাল থেকে শুভেচ্ছা। আপনার সুস্বাস্থ্য কামনা করছি।`;
            }
            
            document.getElementById('dueSmsText').value = dueSms;
            updateCharCount('dueSmsText', 'dueCharCount');
        }

        // Update Treatment History based on filter
        function updateTreatmentHistory() {
            let filteredTreatments = [...allTreatments];
            
            // Apply filter
            switch(currentFilter) {
                case 'due':
                    filteredTreatments = filteredTreatments.filter(t => !t.isPaid);
                    break;
                case 'paid':
                    filteredTreatments = filteredTreatments.filter(t => t.isPaid);
                    break;
                case 'crown':
                    filteredTreatments = filteredTreatments.filter(t => t.hasCrown);
                    break;
                case 'recent':
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    filteredTreatments = filteredTreatments.filter(t => {
                        const treatmentDate = new Date(t.treatmentDate || t.id);
                        return treatmentDate >= sevenDaysAgo;
                    });
                    break;
                case 'all':
                default:
                    // Show all
                    break;
            }
            
            // Display treatments
            if (filteredTreatments.length === 0) {
                document.getElementById('treatmentHistory').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search empty-icon"></i>
                        <p>${getFilterMessage()} কোনো চিকিৎসা নেই</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">অন্য ফিল্টার নির্বাচন করুন</p>
                    </div>
                `;
                return;
            }
            
            let treatmentsHistory = '';
            
            filteredTreatments.forEach((treatment) => {
                const treatmentTotal = parseFloat(treatment.total || treatment.treatmentCost || 0);
                const treatmentPaid = parseFloat(treatment.paid || 0);
                const treatmentDue = parseFloat(treatment.due || treatmentTotal - treatmentPaid);
                
                const isPaid = treatment.isPaid;
                const cardClass = isPaid ? 'history-card paid' : 'history-card due';
                
                let paymentLogs = '';
                if (treatment.paymentHistory && treatment.paymentHistory.length > 0) {
                    paymentLogs = `
                        <div class="payment-log">
                            <h4 style="margin-bottom: 10px; font-size: 1rem;">
                                <i class="fas fa-receipt"></i> পেমেন্ট লগ:
                            </h4>
                            ${treatment.paymentHistory.map(log => `
                                <div class="log-item">
                                    <span>📅 ${log.time || log.date || 'তারিখ নেই'}</span>
                                    <span><strong>+ ${log.amount} ৳</strong></span>
                                    ${log.notes ? `<br><span style="color: var(--gray); font-size: 0.9rem;">${log.notes}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                treatmentsHistory += `
                    <div class="${cardClass}">
                        <div class="history-header">
                            <div>
                                <h3 style="margin: 0; color: ${isPaid ? 'var(--success)' : 'var(--danger)'};">${treatment.problem || 'চিকিৎসা'}</h3>
                                <div class="history-date">
                                    <i class="far fa-calendar"></i>
                                    ${treatment.date || 'তারিখ নেই'}
                                </div>
                            </div>
                            <div class="history-amount" style="color: ${isPaid ? 'var(--success)' : 'var(--danger)'};">৳ ${treatmentTotal.toLocaleString('bn-BD')}</div>
                        </div>
                        
                        <div class="history-details">
                            ${treatment.solution ? `
                                <div class="detail-row">
                                    <div class="detail-label">বিবরণ:</div>
                                    <div class="detail-value">${treatment.solution}</div>
                                </div>
                            ` : ''}
                            
                            ${treatment.crownType && treatment.crownType !== 'নাই' ? `
                                <div class="detail-row">
                                    <div class="detail-label">ক্রাউন:</div>
                                    <div class="detail-value">${treatment.crownType} (${treatment.crownQty || 1} টি)</div>
                                </div>
                            ` : ''}
                            
                            <div class="detail-row">
                                <div class="detail-label">মোট বিল:</div>
                                <div class="detail-value">৳ ${treatmentTotal.toLocaleString('bn-BD')}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">জমা:</div>
                                <div class="detail-value" style="color: var(--success);">৳ ${treatmentPaid.toLocaleString('bn-BD')}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">বকেয়া:</div>
                                <div class="detail-value" style="color: var(--danger); font-weight: 600;">৳ ${treatmentDue.toLocaleString('bn-BD')}</div>
                            </div>
                        </div>
                        
                        ${paymentLogs}
                    </div>
                `;
            });
            
            document.getElementById('treatmentHistory').innerHTML = treatmentsHistory;
        }

        // Helper function to get filter message
        function getFilterMessage() {
            switch(currentFilter) {
                case 'due': return 'বকেয়া আছে এমন';
                case 'paid': return 'পরিশোধিত';
                case 'crown': return 'ক্রাউন আছে এমন';
                case 'recent': return 'সাম্প্রতিক ৭ দিনের';
                default: return '';
            }
        }

        // Helper function to get last treatment date
        function getLastTreatmentDate(patientData) {
            if (!patientData.treatments || patientData.treatments.length === 0) {
                return patientData.lastUpdated || patientData.createdAt || new Date().toISOString();
            }
            
            // Try to get the latest treatment date
            const sortedTreatments = [...patientData.treatments].sort((a, b) => {
                const dateA = a.date ? new Date(a.date) : (a.id ? new Date(parseInt(a.id)) : new Date(0));
                const dateB = b.date ? new Date(b.date) : (b.id ? new Date(parseInt(b.id)) : new Date(0));
                return dateB - dateA;
            });
            
            return sortedTreatments[0].date || sortedTreatments[0].id || new Date().toISOString();
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'তারিখ নেই';
            
            try {
                let date;
                // Check if it's a timestamp
                if (/^\d+$/.test(dateString)) {
                    date = new Date(parseInt(dateString));
                } else {
                    date = new Date(dateString);
                }
                
                return date.toLocaleDateString('bn-BD', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Character Count Update for Bengali SMS
        function updateCharCount(textareaId, countId) {
            const textarea = document.getElementById(textareaId);
            const countElement = document.getElementById(countId);
            
            if (textarea && countElement) {
                const updateCount = () => {
                    const text = textarea.value;
                    const count = text.length;
                    countElement.textContent = `${count}/70`;
                    
                    if (count > 70) {
                        countElement.classList.add('warning');
                    } else {
                        countElement.classList.remove('warning');
                    }
                };
                
                updateCount();
                textarea.addEventListener('input', updateCount);
            }
        }

        // SMS API key (should be stored securely in production)
        // Note: In production, use environment variables or Firebase Config
        const SMS_API_KEY = "e66426c4087b334647fb3ae9d933045e959dc885";

        // Send SMS with better error handling
        async function sendSms(message, type) {
            try {
                if (!currentPatient) {
                    showMessage("রোগী নির্বাচন করুন!", "error");
                    return;
                }

                // Check message length for Bengali SMS
                if (message.length > 70) {
                    showMessage("বাংলা এসএমএস ৭০ অক্ষরের বেশি হবে না!", "warning");
                    return;
                }

                const patientData = currentPatient.data;
                const phoneNumber = patientData.phone;

                if (!phoneNumber) {
                    showMessage("রোগীর মোবাইল নাম্বার নেই!", "error");
                    return;
                }

                // Validate phone number
                const cleanedPhone = phoneNumber.replace(/\D/g, '');
                if (cleanedPhone.length < 11) {
                    showMessage("মোবাইল নাম্বারটি সঠিক নয়!", "error");
                    return;
                }

                // Show sending status
                showMessage(`${type} এসএমএস পাঠানো হচ্ছে...`, "info");

                // SMS API integration with better error handling
                const encodedMessage = encodeURIComponent(message);
                const url = `https://bulksmsdhaka.net/api/sendtext?apikey=${SMS_API_KEY}&callerID=ChowdhuryDental&number=${cleanedPhone}&message=${encodedMessage}`;
                
                // Fetch with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                try {
                    const response = await fetch(url, {
                        signal: controller.signal,
                        method: 'GET'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log("SMS API Response:", result);
                    
                    if (result.status === 'SUCCESS' || result.success === true) {
                        showMessage(`${type} এসএমএস সফলভাবে পাঠানো হয়েছে!`, "success");
                        
                        // Log SMS in patient data
                        await logSmsToPatient(message, type, phoneNumber);
                        
                    } else {
                        showMessage("এসএমএস পাঠানো যায়নি! API এরর", "error");
                    }
                    
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        showMessage("এসএমএস পাঠানোতে টাইমআউট হয়েছে!", "error");
                    } else {
                        showMessage("এসএমএস পাঠাতে নেটওয়ার্ক এরর!", "error");
                    }
                }

            } catch (error) {
                console.error("SMS send error:", error);
                showMessage("এসএমএস পাঠাতে সমস্যা হয়েছে!", "error");
            }
        }

        // Log SMS to patient record
        async function logSmsToPatient(message, type, phoneNumber) {
            try {
                if (!currentPatient) return;
                
                const patientDoc = doc(db, "patients", currentPatient.id);
                const smsLog = {
                    type: type,
                    message: message,
                    phone: phoneNumber,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString('bn-BD')
                };
                
                await updateDoc(patientDoc, {
                    smsHistory: arrayUnion(smsLog),
                    lastUpdated: new Date().toISOString()
                });
                
            } catch (error) {
                console.error("Error logging SMS:", error);
                // Don't show error to user for logging failure
            }
        }

        // Filter buttons functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update current filter
                currentFilter = this.getAttribute('data-filter');
                
                // Update treatment history
                updateTreatmentHistory();
            });
        });

        // Search in patient selection modal
        document.getElementById('patientSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const patientItems = document.querySelectorAll('.patient-item');
            
            patientItems.forEach(item => {
                const patientName = item.querySelector('h4').textContent.toLowerCase();
                const patientPhone = item.querySelector('p').textContent.toLowerCase();
                
                if (patientName.includes(searchTerm) || patientPhone.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Initialize event listeners
        function initEventListeners() {
            // Switch to next patient
            document.getElementById('switchPatientBtn').addEventListener('click', showPatientSelectionModal);

            // Add Payment
            document.getElementById('addPaymentBtn').addEventListener('click', () => {
                document.getElementById('paymentSection').classList.add('active');
                document.getElementById('paymentAmount').focus();
            });

            // Cancel Payment
            document.getElementById('cancelPaymentBtn').addEventListener('click', () => {
                document.getElementById('paymentSection').classList.remove('active');
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNotes').value = '';
                document.getElementById('paymentDate').value = '';
            });

            // Cancel Patient Selection
            document.getElementById('cancelPatientSelection').addEventListener('click', () => {
                document.getElementById('patientSelectionModal').classList.remove('active');
                document.getElementById('patientSearch').value = '';
            });

            // Submit Payment
            document.getElementById('submitPaymentBtn').addEventListener('click', submitPayment);

            // Edit Patient
            document.getElementById('editPatientBtn').addEventListener('click', showEditPatientModal);

            // Cancel Edit
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                document.getElementById('editPatientModal').classList.remove('active');
            });

            // Submit Edit Form
            document.getElementById('editPatientForm').addEventListener('submit', submitEditPatientForm);

            // Send SMS Buttons
            document.getElementById('sendDueSmsBtn').addEventListener('click', () => {
                const message = document.getElementById('dueSmsText').value.trim();
                if (message) {
                    sendSms(message, "বকেয়া বিল");
                }
            });

            document.getElementById('sendCrownSmsBtn').addEventListener('click', () => {
                const message = document.getElementById('crownSmsText').value.trim();
                if (message) {
                    sendSms(message, "ক্রাউন/ক্যাপ");
                }
            });

            document.getElementById('sendCustomSmsBtn').addEventListener('click', () => {
                const message = document.getElementById('customSmsText').value.trim();
                if (message) {
                    sendSms(message, "কাস্টম মেসেজ");
                }
            });

            // Other Actions
            document.getElementById('addTreatmentBtn').addEventListener('click', () => {
                if (currentPatient && currentPatient.data) {
                    window.location.href = `amarghor.html?phone=${currentPatient.data.phone}&name=${encodeURIComponent(currentPatient.data.name)}`;
                } else {
                    window.location.href = "amarghor.html#new-patient";
                }
            });

            document.getElementById('backBtn').addEventListener('click', () => {
                window.history.back();
            });

            document.getElementById('backToDashboardBtn').addEventListener('click', () => {
                window.location.href = "amarghor.html";
            });

            // Print functionality
            document.getElementById('printBtn').addEventListener('click', () => {
                window.print();
            });

            // Export functionality (placeholder)
            document.getElementById('exportBtn').addEventListener('click', () => {
                exportPatientReport();
            });

            // Set default date for payment
            document.getElementById('paymentDate').value = new Date().toISOString().slice(0, 16);
        }

        // Show patient selection modal
        function showPatientSelectionModal() {
            const modalMessage = document.getElementById('modalMessage');
            const patientList = document.getElementById('patientList');
            
            modalMessage.textContent = `এই মোবাইল নাম্বারে ${allPatientsWithSamePhone.length} জন রোগী পাওয়া গেছে। নিচ থেকে নির্বাচন করুন:`;
            patientList.innerHTML = '';
            
            allPatientsWithSamePhone.forEach((patient, index) => {
                const patientData = patient.data;
                const lastTreatmentDate = getLastTreatmentDate(patientData);
                
                const patientItem = document.createElement('div');
                patientItem.className = 'patient-item';
                if (index === currentPatientIndex) {
                    patientItem.classList.add('active');
                }
                
                patientItem.innerHTML = `
                    <h4 style="margin-bottom: 5px; color: var(--primary);">${patientData.name}</h4>
                    <p style="color: var(--gray); margin-bottom: 5px;">
                        <i class="fas fa-user"></i> ${patientData.age || 'নেই'} বছর
                        ${patientData.address ? ` | <i class="fas fa-home"></i> ${patientData.address}` : ''}
                    </p>
                    <p style="color: var(--dark); font-size: 0.9rem;">
                        সর্বশেষ চিকিৎসা: ${formatDate(lastTreatmentDate)}
                    </p>
                    <p style="color: var(--warning); font-size: 0.8rem; margin-top: 5px;">
                        মোট চিকিৎসা: ${patientData.treatments ? patientData.treatments.length : 0} টি
                    </p>
                `;
                
                patientItem.addEventListener('click', () => {
                    currentPatientIndex = index;
                    loadCurrentPatient();
                    document.getElementById('patientSelectionModal').classList.remove('active');
                    document.getElementById('patientSearch').value = '';
                });
                
                patientList.appendChild(patientItem);
            });
            
            document.getElementById('patientSelectionModal').classList.add('active');
        }

        // Submit payment
        async function submitPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (!amount || amount <= 0) {
                showMessage("টাকার পরিমাণ দিন!", "error");
                return;
            }

            if (!currentPatient) {
                showMessage("রোগী নির্বাচন করুন!", "error");
                return;
            }

            try {
                const patientDoc = doc(db, "patients", currentPatient.id);
                const patientSnap = await getDoc(patientDoc);
                
                if (!patientSnap.exists()) {
                    showMessage("রোগী ডেটা পাওয়া যায়নি!", "error");
                    return;
                }

                const patientData = patientSnap.data();
                const treatments = patientData.treatments || [];
                
                const paymentTime = date 
                    ? new Date(date).toLocaleString('bn-BD', { hour12: true })
                    : new Date().toLocaleString('bn-BD', { hour12: true });
                
                const paymentLog = {
                    time: paymentTime,
                    amount: amount,
                    notes: notes || '',
                    date: new Date().toISOString(),
                    treatedBy: "চৌধুরী ডেন্টাল"
                };

                let remainingAmount = amount;
                const updatedTreatments = treatments.map(treatment => {
                    if (remainingAmount <= 0) return treatment;
                    
                    const treatmentDue = parseFloat(treatment.due || 0);
                    if (treatmentDue > 0) {
                        const paymentForThisTreatment = Math.min(remainingAmount, treatmentDue);
                        
                        if (!treatment.paymentHistory) {
                            treatment.paymentHistory = [];
                        }
                        
                        treatment.paymentHistory.push({
                            ...paymentLog,
                            amount: paymentForThisTreatment
                        });
                        
                        treatment.paid = (parseFloat(treatment.paid || 0) + paymentForThisTreatment);
                        treatment.due = treatmentDue - paymentForThisTreatment;
                        
                        remainingAmount -= paymentForThisTreatment;
                    }
                    return treatment;
                });

                await updateDoc(patientDoc, {
                    treatments: updatedTreatments,
                    lastUpdated: new Date().toISOString()
                });

                showMessage("পেমেন্ট সফলভাবে জমা দেওয়া হয়েছে!", "success");
                
                // Reset form
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNotes').value = '';
                document.getElementById('paymentDate').value = new Date().toISOString().slice(0, 16);
                document.getElementById('paymentSection').classList.remove('active');
                
                // Reload current patient data
                await loadPatientsByPhone(currentPhone, currentPatient.id);
                
            } catch (error) {
                console.error("Error submitting payment:", error);
                showMessage("পেমেন্ট জমা দিতে সমস্যা হয়েছে!", "error");
            }
        }

        // Show edit patient modal
        function showEditPatientModal() {
            if (!currentPatient) {
                showMessage("রোগী নির্বাচন করুন!", "error");
                return;
            }

            const patientData = currentPatient.data;
            
            // Fill form with current data
            document.getElementById('editName').value = patientData.name || '';
            document.getElementById('editAge').value = patientData.age || '';
            document.getElementById('editPhone').value = patientData.phone || '';
            document.getElementById('editAddress').value = patientData.address || '';
            
            document.getElementById('editPatientModal').classList.add('active');
        }

        // Submit edit patient form
        async function submitEditPatientForm(e) {
            e.preventDefault();
            
            const name = document.getElementById('editName').value.trim();
            const age = document.getElementById('editAge').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            
            if (!name || !phone) {
                showMessage("নাম ও মোবাইল নাম্বার আবশ্যক!", "error");
                return;
            }

            try {
                const patientDoc = doc(db, "patients", currentPatient.id);
                
                await updateDoc(patientDoc, {
                    name: name,
                    age: age || '',
                    phone: phone,
                    address: address || '',
                    lastUpdated: new Date().toISOString()
                });

                showMessage("রোগী তথ্য সফলভাবে আপডেট হয়েছে!", "success");
                
                // Close modal
                document.getElementById('editPatientModal').classList.remove('active');
                
                // Reload patient data
                await loadPatientsByPhone(phone, currentPatient.id);
                
            } catch (error) {
                console.error("Error updating patient:", error);
                showMessage("তথ্য আপডেট করতে সমস্যা হয়েছে!", "error");
            }
        }

        // Export patient report
        function exportPatientReport() {
            if (!currentPatient) {
                showMessage("রোগী নির্বাচন করুন!", "error");
                return;
            }

            const patientData = currentPatient.data;
            const patientName = patientData.name || 'রোগী';
            const date = new Date().toLocaleDateString('bn-BD');
            
            // Create report content
            let reportContent = `
                === চৌধুরী ডেন্টাল - রোগী রিপোর্ট ===
                তারিখ: ${date}
                রোগীর নাম: ${patientData.name || 'নেই'}
                মোবাইল: ${patientData.phone || 'নেই'}
                বয়স: ${patientData.age || 'নেই'}
                ঠিকানা: ${patientData.address || 'নেই'}
                
                === পরিসংখ্যান ===
                মোট বিল: ৳ ${document.getElementById('totalBill').textContent.split('৳ ')[1]}
                মোট জমা: ৳ ${document.getElementById('totalPaid').textContent.split('৳ ')[1]}
                মোট বকেয়া: ৳ ${document.getElementById('totalDue').textContent.split('৳ ')[1]}
                মোট চিকিৎসা: ${document.getElementById('totalTreatments').textContent}
                
                === চিকিৎসা ইতিহাস ===
            `;
            
            if (allTreatments.length > 0) {
                allTreatments.forEach((treatment, index) => {
                    reportContent += `
                ${index + 1}. ${treatment.problem || 'চিকিৎসা'}
                   তারিখ: ${treatment.date || 'নেই'}
                   বিল: ৳ ${parseFloat(treatment.total || 0).toLocaleString('bn-BD')}
                   জমা: ৳ ${parseFloat(treatment.paid || 0).toLocaleString('bn-BD')}
                   বকেয়া: ৳ ${parseFloat(treatment.due || 0).toLocaleString('bn-BD')}
                   ${treatment.solution ? `বিবরণ: ${treatment.solution}` : ''}
                   
                `;
                });
            } else {
                reportContent += '    কোনো চিকিৎসা ইতিহাস নেই\n';
            }
            
            reportContent += '\n=== রিপোর্ট শেষ ===\n';
            
            // Create blob and download
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${patientName}_রিপোর্ট_${date.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage("রিপোর্ট ডাউনলোড শুরু হয়েছে!", "success");
        }

        // Initialize character counts
        updateCharCount('dueSmsText', 'dueCharCount');
        updateCharCount('customSmsText', 'customCharCount');

        // Show Message Function
        function showMessage(message, type) {
            const existingMessages = document.querySelectorAll('.message-box');
            existingMessages.forEach(msg => msg.remove());
            
            const messageEl = document.createElement('div');
            messageEl.className = `message-box message-${type}`;
            messageEl.textContent = message;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => messageEl.remove(), 300);
            }, 4000);
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
        });
    </script>
</body>
</html>