<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>চৌধুরী ডেন্টাল - প্রফেশনাল ম্যানেজমেন্ট সিস্টেম</title>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --success: #28a745;
            --success-dark: #1e7e34;
            --danger: #dc3545;
            --warning: #ff9800;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f2ff 100%);
            color: #333;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        /* Navigation Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 0;
            z-index: 1000;
            transition: var(--transition);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .nav-menu {
            list-style: none;
            padding: 0 15px;
        }

        .nav-item {
            margin-bottom: 8px;
            border-radius: 10px;
            overflow: hidden;
            transition: var(--transition);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-link i {
            font-size: 1.2rem;
            margin-right: 15px;
            width: 25px;
            text-align: center;
        }

        .nav-link:hover {
            transform: translateX(5px);
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 25px;
            min-height: 100vh;
            transition: var(--transition);
        }

        /* Header Bar */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-right: 15px;
            color: var(--primary);
            font-size: 2.2rem;
        }

        .logout-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }

        .logout-btn i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4);
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px solid transparent;
            min-height: 200px;
        }

        .dashboard-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        }

        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 2.2rem;
            color: white;
        }

        .card-new-patient .card-icon {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
        }

        .card-lab-entry .card-icon {
            background: linear-gradient(135deg, var(--warning) 0%, #e68900 100%);
        }

        .card-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .card-desc {
            color: var(--gray);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Form Container */
        .form-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 35px;
            margin-bottom: 30px;
            display: none;
        }

        .form-container.active {
            display: block;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-title {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
        }

        .form-title i {
            margin-right: 15px;
            color: var(--primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: #fcfcfc;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        /* Crown Section */
        .crown-section {
            background: #fffde7;
            padding: 25px;
            border-radius: 10px;
            border: 2px dashed var(--warning);
            margin: 25px 0;
            display: none;
        }

        .crown-section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Calculation Section */
        .calculation-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            border-left: 5px solid var(--primary);
        }

        .calculation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .calc-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .calc-label {
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 10px;
            display: block;
        }

        .calc-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        /* Discount Section */
        .discount-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid var(--success);
        }

        .discount-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Buttons */
        .btn {
            padding: 16px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68900 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .btn i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Toggle Button */
        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
        }

        .toggle-checkbox {
            display: none;
        }

        .toggle-slider {
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 30px;
            position: relative;
            margin-right: 15px;
            transition: var(--transition);
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: var(--transition);
        }

        .toggle-checkbox:checked + .toggle-slider {
            background: var(--success);
        }

        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .toggle-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        /* Search Section */
        .search-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .search-input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1.1rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 230px;
            }
            .main-content {
                margin-left: 230px;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: var(--primary);
                color: white;
                border: none;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                font-size: 1.5rem;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px 15px;
            }
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            .header-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            .search-input-group {
                flex-direction: column;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
        }

        .message-error {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
        }

        .message-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68900 100%);
        }
    </style>
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>চৌধুরী ডেন্টাল</h1>
            <p>কেস ম্যানেজমেন্ট সিস্টেম</p>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" data-target="dashboard">
                <a href="#" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>ড্যাশবোর্ড</span>
                </a>
            </li>
            <li class="nav-item" data-target="new-patient">
                <a href="#" class="nav-link">
                    <i class="fas fa-user-plus"></i>
                    <span>নতুন রোগী এন্ট্রি</span>
                </a>
            </li>
            <li class="nav-item" data-target="lab-entry">
                <a href="#" class="nav-link">
                    <i class="fas fa-flask"></i>
                    <span>ল্যাব এন্ট্রি</span>
                </a>
            </li>
            <li class="nav-item" data-target="patient-history">
                <a href="#" class="nav-link">
                    <i class="fas fa-history"></i>
                    <span>রোগীর হিস্ট্রি</span>
                </a>
            </li>
            <li class="nav-item" data-target="lab-history">
                <a href="#" class="nav-link">
                    <i class="fas fa-vial"></i>
                    <span>ল্যাবের হিস্ট্রি</span>
                </a>
            </li>
            <li class="nav-item" data-target="patient-numbers">
                <a href="#" class="nav-link">
                    <i class="fas fa-phone"></i>
                    <span>রোগীর সকল নাম্বার</span>
                </a>
            </li>
            <li class="nav-item" data-target="new-treatment">
                <a href="#" class="nav-link">
                    <i class="fas fa-stethoscope"></i>
                    <span>নতুন চিকিৎসা এন্ট্রি</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Header -->
        <div class="header-bar">
            <div class="page-title">
                <i class="fas fa-tooth"></i>
                <span id="pageTitle">চৌধুরী ডেন্টাল কেস ম্যানেজমেন্ট</span>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                লগ আউট
            </button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <div class="dashboard-cards">
                <div class="dashboard-card card-new-patient" data-target="new-patient">
                    <div class="card-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3 class="card-title">নতুন রোগী এন্ট্রি</h3>
                    <p class="card-desc">নতুন রোগীর তথ্য যোগ করুন এবং চিকিৎসা বিবরণ সংরক্ষণ করুন</p>
                </div>
                
                <div class="dashboard-card card-lab-entry" data-target="lab-entry">
                    <div class="card-icon">
                        <i class="fas fa-flask"></i>
                    </div>
                    <h3 class="card-title">ল্যাব এন্ট্রি</h3>
                    <p class="card-desc">ডেন্টাল ল্যাবরেটরির কাজের বিবরণ এবং খরচ সংরক্ষণ করুন</p>
                </div>
            </div>

            <!-- Search Patient Section -->
            <div class="search-section">
                <h3 class="form-title">
                    <i class="fas fa-search"></i>
                    রোগী খুঁজুন
                </h3>
                <div class="search-input-group">
                    <input type="tel" id="searchPhone" class="search-input" placeholder="মোবাইল নাম্বার দিন...">
                    <button id="btnSearch" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        রোগী খুঁজুন
                    </button>
                </div>
                <p style="color: var(--gray); margin-top: 10px;">
                    <i class="fas fa-info-circle"></i>
                    রোগীর মোবাইল নাম্বার দিয়ে সার্চ করুন। রোগী পাওয়া গেলে তার প্রোফাইল দেখানো হবে।
                </p>
            </div>
        </div>

        <!-- New Patient Entry Form -->
        <div id="new-patient" class="form-container">
            <h3 class="form-title">
                <i class="fas fa-user-plus"></i>
                নতুন রোগী এন্ট্রি
            </h3>
            
            <form id="patientForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="pName" class="form-label">রোগীর নাম *</label>
                        <input type="text" id="pName" class="form-control" placeholder="রোগীর পূর্ণ নাম" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="pAge" class="form-label">বয়স</label>
                        <input type="number" id="pAge" class="form-control" placeholder="বয়স" min="0" max="120">
                    </div>
                    
                    <div class="form-group">
                        <label for="pPhone" class="form-label">মোবাইল নাম্বার *</label>
                        <input type="tel" id="pPhone" class="form-control" placeholder="মোবাইল নাম্বার (ইংরেজিতে)" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="pAddress" class="form-label">ঠিকানা/গ্রাম</label>
                        <input type="text" id="pAddress" class="form-control" placeholder="বিস্তারিত ঠিকানা">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="pProblem" class="form-label">প্রধান সমস্যা *</label>
                    <select id="pProblem" class="form-control" required>
                        <option value="">সমস্যা নির্বাচন করুন</option>
                        <option value="রুট ক্যানাল">রুট ক্যানাল</option>
                        <option value="দাঁত তোলা">দাঁত তোলা</option>
                        <option value="স্কেলিং ও পলিশিং">স্কেলিং ও পলিশিং</option>
                        <option value="স্থায়ী ফিলিং">স্থায়ী ফিলিং</option>
                        <option value="ডেন্টাল ক্রাউন">ডেন্টাল ক্রাউন</option>
                        <option value="দাঁতের ব্যথা">দাঁতের ব্যথা</option>
                        <option value="অন্যান্য">অন্যান্য</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pSolution" class="form-label">সমাধানের বিবরণ</label>
                    <textarea id="pSolution" class="form-control" placeholder="রোগীর সমস্যার সমাধান ও চিকিৎসার বিবরণ লিখুন..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="treatmentCost" class="form-label">চিকিৎসা খরচ (৳)</label>
                    <input type="number" id="treatmentCost" class="form-control" placeholder="মূল চিকিৎসা খরচ" min="0" value="0">
                </div>
                
                <!-- Crown Section -->
                <div class="toggle-container">
                    <input type="checkbox" id="hasCrown" class="toggle-checkbox">
                    <label for="hasCrown" class="toggle-slider"></label>
                    <span class="toggle-label">ডেন্টাল ক্রাউন/ক্যাপ আছে?</span>
                </div>
                
                <div id="crownDiv" class="crown-section">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="crownType" class="form-label">ক্রাউনের ধরন</label>
                            <select id="crownType" class="form-control">
                                <option value="পোর্সেলিন">পোর্সেলিন ক্রাউন</option>
                                <option value="জিরকোনিয়া মাল্টি লেয়ার">জিরকোনিয়া মাল্টি লেয়ার</option>
                                <option value="মেটাল সিরামিক">মেটাল সিরামিক</option>
                                <option value="ফুল জিরকোনিয়া">ফুল জিরকোনিয়া</option>
                                <option value="ই-ম্যাক্স">ই-ম্যাক্স</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="crownQty" class="form-label">কয়টি ক্রাউন?</label>
                            <input type="number" id="crownQty" class="form-control" placeholder="ক্রাউনের সংখ্যা" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="crownPricePer" class="form-label">প্রতিটির দাম (৳)</label>
                            <input type="number" id="crownPricePer" class="form-control" placeholder="প্রতি ক্রাউনের দাম" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Discount Section -->
                <div class="discount-section">
                    <h4 style="margin-bottom: 15px; color: var(--success);">
                        <i class="fas fa-percentage"></i>
                        ডিসকাউন্ট তথ্য
                    </h4>
                    <div class="discount-grid">
                        <div class="form-group">
                            <label for="discountPercent" class="form-label">ডিসকাউন্ট (%)</label>
                            <input type="number" id="discountPercent" class="form-control" placeholder="ডিসকাউন্ট শতাংশ" min="0" max="100" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="discountAmount" class="form-label">ডিসকাউন্ট (৳)</label>
                            <input type="number" id="discountAmount" class="form-control" placeholder="ডিসকাউন্ট টাকার পরিমাণ" min="0" value="0">
                        </div>
                    </div>
                    <p style="color: var(--gray); margin-top: 10px; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        ডিসকাউন্ট শতাংশ অথবা টাকার পরিমাণ যেকোনো একটি দিন। দুটি দিলে শুধু টাকার পরিমাণ গণনা হবে।
                    </p>
                </div>
                
                <!-- Calculation Section -->
                <div class="calculation-section">
                    <h4 style="margin-bottom: 15px; color: var(--primary);">
                        <i class="fas fa-calculator"></i>
                        বিল গণনা
                    </h4>
                    <div class="calculation-grid">
                        <div class="calc-item">
                            <span class="calc-label">মোট খরচ</span>
                            <div class="calc-value" id="displayTotal">৳ 0</div>
                        </div>
                        
                        <div class="calc-item">
                            <span class="calc-label">ডিসকাউন্ট</span>
                            <div class="calc-value" id="displayDiscount">৳ 0</div>
                        </div>
                        
                        <div class="calc-item">
                            <span class="calc-label">সর্বমোট</span>
                            <div class="calc-value" id="displayFinal">৳ 0</div>
                        </div>
                        
                        <div class="calc-item">
                            <span class="calc-label">জমা টাকা</span>
                            <input type="number" id="pPaid" class="form-control" placeholder="জমা টাকা" min="0" value="0">
                        </div>
                        
                        <div class="calc-item">
                            <span class="calc-label">বকেয়া</span>
                            <div class="calc-value" id="displayDue">৳ 0</div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 1.2rem;">
                    <i class="fas fa-save"></i>
                    রোগীর তথ্য সংরক্ষণ করুন
                </button>
            </form>
        </div>

        <!-- Other Sections (Placeholders) -->
        <div id="lab-entry" class="form-container">
            <h3 class="form-title">
                <i class="fas fa-flask"></i>
                ল্যাব এন্ট্রি (শীঘ্রই আসছে)
            </h3>
            <p style="text-align: center; padding: 50px; color: var(--gray);">
                <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 20px; display: block;"></i>
                ল্যাব এন্ট্রি সেকশনটি ডেভেলপমেন্ট চলছে। শীঘ্রই উপলব্ধ হবে।
            </p>
        </div>
        
       <div id="patient-history" class="form-container">
    <h3 class="form-title">
        <i class="fas fa-history"></i>
        রোগীর হিস্ট্রি
    </h3>
    
    <!-- Filter Section -->
    <div class="search-section" style="margin-bottom: 25px;">
        <h4 style="margin-bottom: 15px; color: var(--primary);">
            <i class="fas fa-filter"></i>
            ফিল্টার অপশন
        </h4>
        <div class="search-input-group">
            <input type="tel" id="filterPhone" class="search-input" placeholder="মোবাইল নাম্বার দিয়ে ফিল্টার করুন...">
            <input type="text" id="filterName" class="search-input" placeholder="নাম দিয়ে ফিল্টার করুন...">
            <button id="btnFilterClear" class="btn btn-warning">
                <i class="fas fa-times"></i>
                ফিল্টার সরান
            </button>
        </div>
        <p style="color: var(--gray); margin-top: 10px;">
            <i class="fas fa-info-circle"></i>
            সর্বশেষ এন্ট্রি করা রোগী সবার উপরে দেখানো হবে। পুরনো রোগী খুঁজতে উপরে মোবাইল নাম্বার দিয়ে ফিল্টার করুন।
        </p>
    </div>
    
    <!-- Patient History Table -->
    <div class="table-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="color: var(--primary);">
                <i class="fas fa-users"></i>
                মোট রোগী: <span id="totalPatients">0</span>
            </h4>
            <button id="btnRefreshHistory" class="btn btn-success">
                <i class="fas fa-sync-alt"></i>
                রিফ্রেশ করুন
            </button>
        </div>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <thead>
                    <tr style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                        <th style="padding: 15px; text-align: left; font-weight: 600;">ক্রমিক</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">মোবাইল নাম্বার</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">রোগীর নাম</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">সমস্যা</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">মোট টাকা</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">জমা টাকা</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">বকেয়া</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">সর্বশেষ তারিখ</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600;">কর্ম</th>
                    </tr>
                </thead>
                <tbody id="patientHistoryTable">
                    <!-- Data will be loaded here -->
                    <tr>
                        <td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px; display: block;"></i>
                            রোগীর তথ্য লোড হচ্ছে...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <div style="color: var(--gray);">
                পৃষ্ঠা <span id="currentPage">1</span> এর <span id="totalPages">1</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btnPrevPage" class="btn btn-primary" disabled>
                    <i class="fas fa-chevron-left"></i>
                    আগের
                </button>
                <button id="btnNextPage" class="btn btn-primary" disabled>
                    পরের
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
        
        <div id="lab-history" class="form-container">
            <h3 class="form-title">
                <i class="fas fa-vial"></i>
                ল্যাবের হিস্ট্রি (শীঘ্রই আসছে)
            </h3>
            <p style="text-align: center; padding: 50px; color: var(--gray);">
                <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 20px; display: block;"></i>
                ল্যাবের হিস্ট্রি সেকশনটি ডেভেলপমেন্ট চলছে। শীঘ্রই উপলব্ধ হবে।
            </p>
        </div>
        
        <div id="patient-numbers" class="form-container">
            <h3 class="form-title">
                <i class="fas fa-phone"></i>
                রোগীর সকল নাম্বার
            </h3>
            <div style="text-align: center; padding: 30px;">
                <button id="btnCopy" class="btn btn-warning" style="margin-bottom: 30px;">
                    <i class="fas fa-copy"></i>
                    সব রুগীর নাম্বার কপি করুন
                </button>
                <div id="phoneList" style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 200px;">
                    <p style="color: var(--gray);">নাম্বার লোড হচ্ছে...</p>
                </div>
            </div>
        </div>
        
        <div id="new-treatment" class="form-container">
            <h3 class="form-title">
                <i class="fas fa-stethoscope"></i>
                নতুন চিকিৎসা এন্ট্রি (শীঘ্রই আসছে)
            </h3>
            <p style="text-align: center; padding: 50px; color: var(--gray);">
                <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 20px; display: block;"></i>
                নতুন চিকিৎসা এন্ট্রি সেকশনটি ডেভেলপমেন্ট চলছে। শীঘ্রই উপলব্ধ হবে।
            </p>
        </div>
    </main>

    <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        getDoc, 
        updateDoc, 
        arrayUnion, 
        collection, 
        getDocs 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAxz46ug-CAywevI-PzmOp7ba5iiCK9dfM",
        authDomain: "plasma-raceway-465016-v0.firebaseapp.com",
        projectId: "plasma-raceway-465016-v0",
        storageBucket: "plasma-raceway-465016-v0.appspot.com",
        messagingSenderId: "23620370976",
        appId: "1:23620370976:web:3bb119ceb9e15608a33245"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Authentication Check
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "log.html"; // Login page
        }
    });

    // UI Elements
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mainContent = document.getElementById('mainContent');
    const pageTitle = document.getElementById('pageTitle');
    const sections = document.querySelectorAll('.section, .form-container');
    const navItems = document.querySelectorAll('.nav-item');
    const dashboardCards = document.querySelectorAll('.dashboard-card');

    // Patient History Variables
    let allPatients = [];
    let filteredPatients = [];
    let currentPage = 1;
    const patientsPerPage = 15;
    let historyLoaded = false;

    // Mobile Menu Toggle
    mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });

    // Navigation Function
    function navigateToSection(sectionId, sectionName) {
        // Hide all sections
        sections.forEach(section => {
            section.classList.remove('active');
        });
        
        // Show target section
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Update page title
        pageTitle.textContent = sectionName || 'চৌধুরী ডেন্টাল কেস ম্যানেজমেন্ট';
        
        // Update active nav item
        navItems.forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-target') === sectionId) {
                item.classList.add('active');
            }
        });
        
        // Close mobile menu
        sidebar.classList.remove('active');
        
        // Auto-load patient history when the section is opened
        if (sectionId === 'patient-history' && !historyLoaded) {
            setTimeout(() => {
                loadPatientHistory();
                historyLoaded = true;
            }, 300);
        }
    }

    // Navigation Event Listeners
    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const target = item.getAttribute('data-target');
            const itemName = item.querySelector('span').textContent;
            navigateToSection(target, itemName);
        });
    });

    // Dashboard Cards Event Listeners
    dashboardCards.forEach(card => {
        card.addEventListener('click', () => {
            const target = card.getAttribute('data-target');
            navigateToSection(target, card.querySelector('.card-title').textContent);
        });
    });

    // Crown Toggle
    document.getElementById('hasCrown').addEventListener('change', function(e) {
        const crownDiv = document.getElementById('crownDiv');
        if (e.target.checked) {
            crownDiv.classList.add('active');
        } else {
            crownDiv.classList.remove('active');
        }
        updateCalculations();
    });

    // Calculation Update Function
    function updateCalculations() {
        // Get values
        const treatmentCost = parseFloat(document.getElementById('treatmentCost').value) || 0;
        const hasCrown = document.getElementById('hasCrown').checked;
        const crownQty = parseFloat(document.getElementById('crownQty').value) || 0;
        const crownPrice = parseFloat(document.getElementById('crownPricePer').value) || 0;
        const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
        const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
        const paid = parseFloat(document.getElementById('pPaid').value) || 0;
        
        // Calculate total
        let total = treatmentCost;
        if (hasCrown) {
            total += (crownQty * crownPrice);
        }
        
        // Calculate discount
        let discount = discountAmount;
        if (discountPercent > 0 && discountAmount === 0) {
            discount = (total * discountPercent) / 100;
        }
        
        // Ensure discount doesn't exceed total
        if (discount > total) {
            discount = total;
            document.getElementById('discountAmount').value = discount;
            document.getElementById('discountPercent').value = 0;
        }
        
        // Calculate final amount and due
        const finalAmount = total - discount;
        const due = finalAmount - paid;
        
        // Update display
        document.getElementById('displayTotal').textContent = `৳ ${total.toLocaleString('bn-BD')}`;
        document.getElementById('displayDiscount').textContent = `৳ ${discount.toLocaleString('bn-BD')}`;
        document.getElementById('displayFinal').textContent = `৳ ${finalAmount.toLocaleString('bn-BD')}`;
        document.getElementById('displayDue').textContent = `৳ ${due.toLocaleString('bn-BD')}`;
        
        // Update form fields if they exist
        if (document.getElementById('pTotal')) {
            document.getElementById('pTotal').value = finalAmount;
        }
        if (document.getElementById('pDue')) {
            document.getElementById('pDue').value = due;
        }
    }

    // Add calculation fields to the form
    const form = document.getElementById('patientForm');
    if (form) {
        const totalInput = document.createElement('input');
        totalInput.type = 'hidden';
        totalInput.id = 'pTotal';
        totalInput.value = '0';
        
        const dueInput = document.createElement('input');
        dueInput.type = 'hidden';
        dueInput.id = 'pDue';
        dueInput.value = '0';
        
        form.appendChild(totalInput);
        form.appendChild(dueInput);

        // Update calculations on input
        ['treatmentCost', 'crownQty', 'crownPricePer', 'discountPercent', 'discountAmount', 'pPaid'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateCalculations);
            }
        });
    }

    // Form Submission
    if (document.getElementById('patientForm')) {
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form values
            const name = document.getElementById('pName').value.trim();
            const age = document.getElementById('pAge').value.trim();
            const phone = document.getElementById('pPhone').value.trim();
            const address = document.getElementById('pAddress').value.trim();
            const problem = document.getElementById('pProblem').value;
            const solution = document.getElementById('pSolution').value;
            const treatmentCost = document.getElementById('treatmentCost').value;
            const hasCrown = document.getElementById('hasCrown').checked;
            const crownType = document.getElementById('crownType').value;
            const crownQty = document.getElementById('crownQty').value || 0;
            const crownPrice = document.getElementById('crownPricePer').value || 0;
            const discountPercent = document.getElementById('discountPercent').value || 0;
            const discountAmount = document.getElementById('discountAmount').value || 0;
            const total = document.getElementById('pTotal').value;
            const paid = document.getElementById('pPaid').value;
            const due = document.getElementById('pDue').value;
            
            // Validation
            if (!name || !phone) {
                showMessage('রোগীর নাম ও মোবাইল নাম্বার অবশ্যই দিতে হবে', 'error');
                return;
            }
            
            const time = new Date().toLocaleString('bn-BD', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true 
            });
            
            // Create treatment object
            const treatment = {
                id: Date.now(),
                date: time,
                name: name,
                problem: problem,
                solution: solution,
                treatmentCost: treatmentCost,
                hasCrown: hasCrown,
                crownType: hasCrown ? crownType : "নাই",
                crownQty: crownQty,
                crownPrice: crownPrice,
                discountPercent: discountPercent,
                discountAmount: discountAmount,
                total: total,
                paid: paid,
                due: due
            };
            
            try {
                // Create a unique ID combining phone and name for individual profiles
                const profileId = `${phone}_${name.replace(/\s+/g, '_')}`;
                const patientRef = doc(db, "patients", profileId);
                const phoneRef = doc(db, "patientPhones", phone);
                
                // Check if this phone number already exists
                const phoneSnap = await getDoc(phoneRef);
                
                if (phoneSnap.exists()) {
                    // Phone exists, add this name to the names array if not already there
                    const existingNames = phoneSnap.data().names || [];
                    if (!existingNames.includes(name)) {
                        await updateDoc(phoneRef, {
                            names: arrayUnion(name)
                        });
                    }
                } else {
                    // New phone number
                    await setDoc(phoneRef, {
                        phone: phone,
                        names: [name],
                        createdAt: new Date().toISOString()
                    });
                }
                
                // Check if patient profile exists
                const patientSnap = await getDoc(patientRef);
                
                if (patientSnap.exists()) {
                    // Patient exists, add new treatment
                    await updateDoc(patientRef, {
                        treatments: arrayUnion(treatment),
                        lastUpdated: new Date().toISOString()
                    });
                } else {
                    // New patient
                    await setDoc(patientRef, {
                        name: name,
                        age: age,
                        phone: phone,
                        address: address,
                        treatments: [treatment],
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    });
                }
                
                showMessage('রোগীর তথ্য সফলভাবে সংরক্ষণ হয়েছে!', 'success');
                
                // Reset form
                e.target.reset();
                document.getElementById('crownDiv').classList.remove('active');
                document.getElementById('hasCrown').checked = false;
                updateCalculations();
                
            } catch (err) {
                console.error("Error saving patient:", err);
                showMessage('তথ্য সংরক্ষণে সমস্যা হয়েছে! আবার চেষ্টা করুন।', 'error');
            }
        });
    }

    // Search Patient
    if (document.getElementById('btnSearch')) {
        document.getElementById('btnSearch').addEventListener('click', async () => {
            const phone = document.getElementById('searchPhone').value.trim();
            
            if (!phone) {
                showMessage('মোবাইল নাম্বার দিন!', 'error');
                return;
            }
            
            try {
                // Search for phone in patientPhones collection
                const phoneRef = doc(db, "patientPhones", phone);
                const phoneSnap = await getDoc(phoneRef);
                
                if (phoneSnap.exists()) {
                    const names = phoneSnap.data().names || [];
                    
                    if (names.length === 1) {
                        // Single patient, redirect directly
                        const profileId = `${phone}_${names[0].replace(/\s+/g, '_')}`;
                        window.location.href = `rugipro.html?profileId=${profileId}`;
                    } else if (names.length > 1) {
                        // Multiple patients with same phone
                        let message = `এই নাম্বারে ${names.length} জন রোগী পাওয়া গেছে:\n\n`;
                        names.forEach((name, index) => {
                            message += `${index + 1}. ${name}\n`;
                        });
                        message += '\nকোন রোগী দেখতে চান?';
                        
                        // In a real app, you'd create a selection modal here
                        // For now, redirect to the first patient
                        const profileId = `${phone}_${names[0].replace(/\s+/g, '_')}`;
                        window.location.href = `rugipro.html?profileId=${profileId}`;
                    }
                } else {
                    showMessage('এই নাম্বারে কোনো রোগী পাওয়া যায়নি!', 'error');
                }
            } catch (err) {
                console.error("Search error:", err);
                showMessage('সার্চ করতে সমস্যা হয়েছে!', 'error');
            }
        });
    }

    // Copy All Phone Numbers
    if (document.getElementById('btnCopy')) {
        document.getElementById('btnCopy').addEventListener('click', async () => {
            try {
                const querySnapshot = await getDocs(collection(db, "patientPhones"));
                let phoneNumbers = [];
                
                querySnapshot.forEach(doc => {
                    phoneNumbers.push(doc.id);
                });
                
                if (phoneNumbers.length > 0) {
                    const phoneList = phoneNumbers.join(', ');
                    await navigator.clipboard.writeText(phoneList);
                    
                    // Display phone numbers
                    const phoneListDiv = document.getElementById('phoneList');
                    phoneListDiv.innerHTML = `
                        <div style="text-align: left;">
                            <h4 style="margin-bottom: 15px; color: var(--primary);">
                                <i class="fas fa-phone"></i>
                                মোট ${phoneNumbers.length}টি নাম্বার
                            </h4>
                            <div style="background: white; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                                ${phoneNumbers.map((phone, index) => `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>${index + 1}.</strong> ${phone}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                    showMessage(`${phoneNumbers.length}টি নাম্বার কপি হয়েছে!`, 'success');
                } else {
                    showMessage('কোনো রোগীর নাম্বার পাওয়া যায়নি!', 'warning');
                }
            } catch (err) {
                console.error("Copy error:", err);
                showMessage('নাম্বার কপি করতে সমস্যা হয়েছে!', 'error');
            }
        });
    }

    // Load Patient History
    async function loadPatientHistory() {
        try {
            const historyTable = document.getElementById('patientHistoryTable');
            historyTable.innerHTML = `
                <tr>
                    <td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px; display: block;"></i>
                        রোগীর তথ্য লোড হচ্ছে...
                    </td>
                </tr>
            `;
            
            // Get all patient phones
            const phoneQuery = await getDocs(collection(db, "patientPhones"));
            const phoneNumbers = [];
            
            phoneQuery.forEach(doc => {
                phoneNumbers.push({
                    phone: doc.id,
                    names: doc.data().names || []
                });
            });
            
            // Get patient details for each phone
            allPatients = [];
            
            for (const phoneData of phoneNumbers) {
                const phone = phoneData.phone;
                
                for (const name of phoneData.names) {
                    try {
                        const profileId = `${phone}_${name.replace(/\s+/g, '_')}`;
                        const patientRef = doc(db, "patients", profileId);
                        const patientSnap = await getDoc(patientRef);
                        
                        if (patientSnap.exists()) {
                            const patientData = patientSnap.data();
                            const treatments = patientData.treatments || [];
                            
                            if (treatments.length > 0) {
                                // Get the latest treatment
                                const latestTreatment = treatments[treatments.length - 1];
                                
                                allPatients.push({
                                    id: profileId,
                                    phone: phone,
                                    name: name,
                                    age: patientData.age || '',
                                    address: patientData.address || '',
                                    problem: latestTreatment.problem || 'নাই',
                                    total: latestTreatment.total || 0,
                                    paid: latestTreatment.paid || 0,
                                    due: latestTreatment.due || 0,
                                    lastDate: latestTreatment.date || patientData.lastUpdated,
                                    treatmentCount: treatments.length,
                                    allTreatments: treatments
                                });
                            }
                        }
                    } catch (err) {
                        console.error(`Error loading patient ${phone}: ${name}`, err);
                    }
                }
            }
            
            // Sort by latest date (descending)
            allPatients.sort((a, b) => {
                return new Date(b.lastDate) - new Date(a.lastDate);
            });
            
            // Set filtered patients to all patients initially
            filteredPatients = [...allPatients];
            
            // Update UI
            updatePatientHistoryTable();
            
        } catch (err) {
            console.error("Error loading patient history:", err);
            const historyTable = document.getElementById('patientHistoryTable');
            historyTable.innerHTML = `
                <tr>
                    <td colspan="9" style="padding: 40px; text-align: center; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px; display: block;"></i>
                        রোগীর তথ্য লোড করতে সমস্যা হয়েছে!
                        <button id="btnRetryLoad" class="btn btn-primary" style="margin-top: 15px;">
                            আবার চেষ্টা করুন
                        </button>
                    </td>
                </tr>
            `;
            
            document.getElementById('btnRetryLoad')?.addEventListener('click', loadPatientHistory);
        }
    }

    // Update Patient History Table
    function updatePatientHistoryTable() {
        const historyTable = document.getElementById('patientHistoryTable');
        const totalPatientsEl = document.getElementById('totalPatients');
        
        // Apply filters if any
        let displayPatients = [...filteredPatients];
        
        // Filter by phone
        const filterPhone = document.getElementById('filterPhone')?.value.trim() || '';
        if (filterPhone) {
            displayPatients = displayPatients.filter(patient => 
                patient.phone.includes(filterPhone)
            );
        }
        
        // Filter by name
        const filterName = document.getElementById('filterName')?.value.trim() || '';
        if (filterName) {
            displayPatients = displayPatients.filter(patient => 
                patient.name.toLowerCase().includes(filterName.toLowerCase())
            );
        }
        
        if (totalPatientsEl) {
            totalPatientsEl.textContent = displayPatients.length;
        }
        
        // Calculate pagination
        const totalPages = Math.ceil(displayPatients.length / patientsPerPage);
        const startIndex = (currentPage - 1) * patientsPerPage;
        const endIndex = startIndex + patientsPerPage;
        const pagePatients = displayPatients.slice(startIndex, endIndex);
        
        // Update table
        if (pagePatients.length === 0) {
            historyTable.innerHTML = `
                <tr>
                    <td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">
                        <i class="fas fa-user-slash" style="font-size: 2rem; margin-bottom: 15px; display: block;"></i>
                        কোনো রোগী পাওয়া যায়নি
                    </td>
                </tr>
            `;
        } else {
            let tableHTML = '';
            
            pagePatients.forEach((patient, index) => {
                const serial = startIndex + index + 1;
                const lastDate = patient.lastDate ? 
                    new Date(patient.lastDate).toLocaleDateString('bn-BD') : 
                    'তারিখ নেই';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #eee; transition: var(--transition);" 
                        onmouseover="this.style.backgroundColor='#f8f9fa'" 
                        onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 15px;">${serial}</td>
                        <td style="padding: 15px; font-weight: 600;">${patient.phone}</td>
                        <td style="padding: 15px;">
                            <strong>${patient.name}</strong>
                            ${patient.age ? `<br><small>বয়স: ${patient.age}</small>` : ''}
                        </td>
                        <td style="padding: 15px;">
                            ${patient.problem}
                            ${patient.treatmentCount > 1 ? `<br><small>${patient.treatmentCount} বার চিকিৎসা</small>` : ''}
                        </td>
                        <td style="padding: 15px; font-weight: 600; color: var(--primary);">৳ ${parseFloat(patient.total || 0).toLocaleString('bn-BD')}</td>
                        <td style="padding: 15px; color: var(--success); font-weight: 600;">৳ ${parseFloat(patient.paid || 0).toLocaleString('bn-BD')}</td>
                        <td style="padding: 15px; color: ${patient.due > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: 600;">
                            ৳ ${parseFloat(patient.due || 0).toLocaleString('bn-BD')}
                        </td>
                        <td style="padding: 15px;">${lastDate}</td>
                        <td style="padding: 15px;">
                            <button class="btn btn-primary btn-sm view-patient-btn" data-id="${patient.id}" style="padding: 8px 15px; font-size: 0.9rem; margin-bottom: 5px;">
                                <i class="fas fa-eye"></i>
                                দেখুন
                            </button>
                            <button class="btn btn-warning btn-sm add-treatment-btn" data-phone="${patient.phone}" data-name="${patient.name}" style="padding: 8px 15px; font-size: 0.9rem;">
                                <i class="fas fa-plus"></i>
                                চিকিৎসা
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            historyTable.innerHTML = tableHTML;
            
            // Add event listeners to buttons
            document.querySelectorAll('.view-patient-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const patientId = this.getAttribute('data-id');
                    window.location.href = `rugipro.html?profileId=${patientId}`;
                });
            });
            
            document.querySelectorAll('.add-treatment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const phone = this.getAttribute('data-phone');
                    const name = this.getAttribute('data-name');
                    
                    // Navigate to new treatment section with pre-filled data
                    navigateToSection('new-patient', 'নতুন রোগী এন্ট্রি');
                    
                    // Fill form with existing patient data
                    setTimeout(() => {
                        document.getElementById('pName').value = name;
                        document.getElementById('pPhone').value = phone;
                        document.getElementById('pPhone').focus();
                    }, 500);
                });
            });
        }
        
        // Update pagination controls
        if (document.getElementById('currentPage')) {
            document.getElementById('currentPage').textContent = currentPage;
        }
        if (document.getElementById('totalPages')) {
            document.getElementById('totalPages').textContent = totalPages;
        }
        
        if (document.getElementById('btnPrevPage')) {
            document.getElementById('btnPrevPage').disabled = currentPage <= 1;
        }
        if (document.getElementById('btnNextPage')) {
            document.getElementById('btnNextPage').disabled = currentPage >= totalPages;
        }
    }

    // Patient History Event Listeners
    if (document.getElementById('filterPhone')) {
        document.getElementById('filterPhone').addEventListener('input', function() {
            currentPage = 1;
            updatePatientHistoryTable();
        });
    }
    
    if (document.getElementById('filterName')) {
        document.getElementById('filterName').addEventListener('input', function() {
            currentPage = 1;
            updatePatientHistoryTable();
        });
    }
    
    if (document.getElementById('btnFilterClear')) {
        document.getElementById('btnFilterClear').addEventListener('click', function() {
            document.getElementById('filterPhone').value = '';
            document.getElementById('filterName').value = '';
            currentPage = 1;
            filteredPatients = [...allPatients];
            updatePatientHistoryTable();
        });
    }
    
    if (document.getElementById('btnRefreshHistory')) {
        document.getElementById('btnRefreshHistory').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> লোড হচ্ছে...';
            this.disabled = true;
            
            loadPatientHistory().finally(() => {
                this.innerHTML = '<i class="fas fa-sync-alt"></i> রিফ্রেশ করুন';
                this.disabled = false;
            });
        });
    }
    
    if (document.getElementById('btnPrevPage')) {
        document.getElementById('btnPrevPage').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                updatePatientHistoryTable();
            }
        });
    }
    
    if (document.getElementById('btnNextPage')) {
        document.getElementById('btnNextPage').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updatePatientHistoryTable();
            }
        });
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => {
            window.location.href = "log.html";
        }).catch((error) => {
            console.error("Logout error:", error);
        });
    });

    // Show Message Function
    function showMessage(message, type) {
        // Remove existing messages
        const existingMessages = document.querySelectorAll('.message-box');
        existingMessages.forEach(msg => msg.remove());
        
        // Create message element
        const messageEl = document.createElement('div');
        messageEl.className = `message-box message-${type}`;
        messageEl.textContent = message;
        
        // Add to page
        document.body.appendChild(messageEl);
        
        // Remove after 4 seconds
        setTimeout(() => {
            messageEl.style.animation = 'slideInRight 0.3s ease-out reverse';
            setTimeout(() => messageEl.remove(), 300);
        }, 4000);
    }

    // Initialize calculations
    updateCalculations();
</script>
</body>
</html>